<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoundWatch IoT Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io@4.0.1/client-dist/socket.io.min.js"></script>
    <style>
        .status-active {
            color: green;
            font-weight: bold;
        }
        .status-inactive {
            color: gray;
        }
        .status-alarm {
            color: red;
            font-weight: bold;
            animation: blinking 1s infinite;
        }
        @keyframes blinking {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .card {
            margin-bottom: 20px;
        }
        #notifications {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>SoundWatch IoT Dashboard</h1>
        <p class="lead">Monitor and control connected NodeMCU devices</p>
        
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Connected Devices</h5>
                    </div>
                    <div class="card-body" id="devices-container">
                        {% if devices %}
                            {% for device_id, device_info in devices.items() %}
                            <div class="card mb-3" id="device-{{ device_id }}">
                                <div class="card-body">
                                    <h5 class="card-title">Device ID: {{ device_id }}</h5>
                                    <p class="card-text">
                                        <strong>Status:</strong> 
                                        <span class="{% if device_info.buzzer_status %}status-alarm{% else %}status-active{% endif %}">
                                            {{ "ALARM ACTIVE" if device_info.buzzer_status else "Normal" }}
                                        </span>
                                    </p>
                                    <p class="card-text">
                                        <strong>Last Update:</strong> {{ device_info.last_update | int }} seconds ago
                                    </p>
                                    <p class="card-text">
                                        <strong>IP Address:</strong> {{ device_info.ip }}
                                    </p>
                                    <div class="mt-3">
                                        <a href="/api/control/{{ device_id }}/turn_on_light" class="btn btn-success">Turn Light ON</a>
                                        <a href="/api/control/{{ device_id }}/turn_off_light" class="btn btn-danger">Turn Light OFF</a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">No devices connected. Connect a NodeMCU device to see it here.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div id="notifications">
                            <div class="alert alert-secondary">
                                System ready. Waiting for notifications...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Connect to Socket.io
        const socket = io();
        
        // Handle alarm notifications
        socket.on('alarm_notification', function(data) {
            const notificationsContainer = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = 'alert alert-danger';
            
            const timestamp = new Date(data.timestamp * 1000).toLocaleTimeString();
            notification.innerHTML = `<strong>${timestamp}</strong>: ${data.message}`;
            
            notificationsContainer.prepend(notification);
        });
        
        // Handle device updates
        socket.on('device_update', function(data) {
            // Update device status in the UI
            const deviceElement = document.getElementById(`device-${data.device_id}`);
            if (deviceElement) {
                // Update UI with new device status
                // Implementation depends on your data structure
            }
        });
        
        // Handle audio label events
        socket.on('audio_label', function(data) {
            console.log('Audio label received:', data);
            // Add code to update UI with audio detection results if needed
        });
        
        // Function to fetch the latest device status periodically
        function updateDeviceStatus() {
            fetch('/api/devices')
                .then(response => response.json())
                .then(data => {
                    // Update the UI with the latest device status
                    console.log('Device status updated:', data);
                })
                .catch(error => console.error('Error fetching device status:', error));
        }
        
        // Update device status every 10 seconds
        setInterval(updateDeviceStatus, 10000);
    </script>
</body>
</html> 